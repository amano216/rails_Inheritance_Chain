<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>検索機能テスト</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css">
    <link rel="stylesheet" href="global-search.css">
    <link rel="stylesheet" href="hamburger-menu.css">
</head>
<body>
    <!-- グローバル検索結果表示エリア -->
    <div id="globalSearchResults"></div>

    <div class="container mx-auto p-8">
        <h1 class="text-3xl font-bold mb-8">検索機能デバッグページ</h1>
        
        <div class="bg-white p-6 rounded-lg shadow-lg mb-8">
            <h2 class="text-xl font-bold mb-4">デバッグ情報</h2>
            <div id="debugInfo" class="space-y-2">
                <p>JavaScript読み込み状況をチェック中...</p>
            </div>
        </div>

        <div class="bg-white p-6 rounded-lg shadow-lg mb-8">
            <h2 class="text-xl font-bold mb-4">テストコンテンツ</h2>
            <p>このページでRails継承チェーンをテストします。</p>
            <p>ApplicationRecordはActiveRecord::Baseを継承しています。</p>
            <p>UserモデルはApplicationRecordを継承しています。</p>
        </div>

        <div class="bg-white p-6 rounded-lg shadow-lg">
            <h2 class="text-xl font-bold mb-4">コンソールログ</h2>
            <pre id="consoleLog" class="bg-gray-100 p-4 rounded text-sm overflow-auto max-h-96"></pre>
        </div>
    </div>

    <script>
        // デバッグ情報を収集
        const debugInfo = document.getElementById('debugInfo');
        const consoleLog = document.getElementById('consoleLog');
        let logMessages = [];

        // コンソールログをキャプチャ
        const originalLog = console.log;
        const originalError = console.error;
        const originalWarn = console.warn;

        function addLog(type, ...args) {
            const message = `[${type}] ${args.join(' ')}`;
            logMessages.push(message);
            consoleLog.textContent = logMessages.join('\n');
        }

        console.log = function(...args) {
            originalLog.apply(console, args);
            addLog('LOG', ...args);
        };

        console.error = function(...args) {
            originalError.apply(console, args);
            addLog('ERROR', ...args);
        };

        console.warn = function(...args) {
            originalWarn.apply(console, args);
            addLog('WARN', ...args);
        };

        // エラーハンドラー
        window.addEventListener('error', (e) => {
            addLog('WINDOW ERROR', e.message, e.filename, e.lineno);
        });

        // DOMContentLoadedでチェック
        document.addEventListener('DOMContentLoaded', () => {
            console.log('DOMContentLoaded fired');
            
            let html = '<div class="space-y-2">';
            
            // 必要なファイルの存在チェック
            html += '<p class="text-sm">✓ test-search.html loaded</p>';
            
            // グローバル変数チェック
            html += '<h3 class="font-bold mt-4">グローバル変数:</h3>';
            html += `<p class="text-sm">window.searchEngine: ${typeof window.searchEngine}</p>`;
            html += `<p class="text-sm">window.allPageContents: ${typeof window.allPageContents}</p>`;
            html += `<p class="text-sm">window.GlobalSearchEngine: ${typeof window.GlobalSearchEngine}</p>`;
            
            // DOM要素チェック
            html += '<h3 class="font-bold mt-4">DOM要素:</h3>';
            const headerSearch = document.querySelector('.header-search-input');
            html += `<p class="text-sm">Header search input: ${headerSearch ? 'Found' : 'Not found'}</p>`;
            
            const oldSearch = document.querySelector('.global-search-input');
            html += `<p class="text-sm">Old search input: ${oldSearch ? 'Found' : 'Not found'}</p>`;
            
            const searchResults = document.getElementById('globalSearchResults');
            html += `<p class="text-sm">Search results div: ${searchResults ? 'Found' : 'Not found'}</p>`;
            
            // ハンバーガーメニューチェック
            const hamburgerMenu = document.querySelector('.hamburger-menu');
            html += `<p class="text-sm">Hamburger menu: ${hamburgerMenu ? 'Found' : 'Not found'}</p>`;
            
            html += '</div>';
            debugInfo.innerHTML = html;
            
            // 手動で検索機能を初期化してみる
            console.log('Attempting manual search initialization...');
            if (typeof initializeGlobalSearch === 'function') {
                console.log('initializeGlobalSearch function found, calling it...');
                initializeGlobalSearch();
            } else {
                console.error('initializeGlobalSearch function not found');
            }
            
            // 検索入力フィールドの状態をチェック
            setTimeout(() => {
                const searchInput = document.querySelector('.header-search-input');
                if (searchInput) {
                    console.log('Search input found, adding test listener...');
                    searchInput.addEventListener('input', (e) => {
                        console.log('Search input changed:', e.target.value);
                    });
                }
            }, 1000);
        });
    </script>

    <!-- 検索機能のスクリプト -->
    <script src="page-content.js"></script>
    <script src="global-search-v2.js"></script>
    <script src="hamburger-menu.js"></script>
</body>
</html>